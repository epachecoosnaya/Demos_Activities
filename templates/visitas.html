{% extends "base.html" %}
{% block content %}

<h3 class="mb-3">Visitas</h3>

<form id="formVisita" method="POST" action="{{ url_for('visitas') }}" enctype="multipart/form-data">
  <div class="card p-3 mb-4">

    <div class="mb-3">
      <label class="form-label">Cliente *</label>
      <input type="text" name="cliente" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Comentarios *</label>
      <textarea name="comentarios" class="form-control" required></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Fotos (m√≠nimo 2) *</label>
      <input type="file" name="fotos" id="fotos" class="form-control" multiple accept="image/*" required>
    </div>

    <input type="hidden" name="firma" id="firma_input">

    <button type="button" class="btn btn-primary" id="btnAbrirFirma">
      Registrar visita
    </button>

  </div>
</form>

<!-- MODAL FIRMA -->
<div class="modal fade" id="modalFirma" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Firma de conformidad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p class="text-muted">Firma con el dedo o mouse (obligatoria)</p>

        <canvas id="canvasFirma"
          width="600"
          height="250"
          style="border:1px solid #ccc; width:100%; touch-action:none;">
        </canvas>

        <button type="button" class="btn btn-outline-secondary mt-2" onclick="limpiarFirma()">
          Limpiar
        </button>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="btnGuardarFirma">
          Confirmar y guardar
        </button>
      </div>

    </div>
  </div>
</div>

<!-- TOAST -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
  <div id="toastError" class="toast text-bg-danger border-0">
    <div class="toast-body" id="toastMsg"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const form = document.getElementById("formVisita");
  const fotosInput = document.getElementById("fotos");
  const btnAbrirFirma = document.getElementById("btnAbrirFirma");
  const btnGuardarFirma = document.getElementById("btnGuardarFirma");
  const modalFirma = new bootstrap.Modal(document.getElementById("modalFirma"));

  const canvas = document.getElementById("canvasFirma");
  const ctx = canvas.getContext("2d");

  let dibujando = false;
  let hayFirma = false;

  function pos(e) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    return {
      x: touch.clientX - rect.left,
      y: touch.clientY - rect.top
    };
  }

  canvas.addEventListener("mousedown", e => {
    dibujando = true;
    hayFirma = true;
    ctx.beginPath();
    const p = pos(e);
    ctx.moveTo(p.x, p.y);
  });

  canvas.addEventListener("mousemove", e => {
    if (!dibujando) return;
    const p = pos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  });

  canvas.addEventListener("mouseup", () => dibujando = false);
  canvas.addEventListener("mouseleave", () => dibujando = false);

  canvas.addEventListener("touchstart", e => {
    e.preventDefault();
    dibujando = true;
    hayFirma = true;
    ctx.beginPath();
    const p = pos(e);
    ctx.moveTo(p.x, p.y);
  });

  canvas.addEventListener("touchmove", e => {
    e.preventDefault();
    if (!dibujando) return;
    const p = pos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  });

  canvas.addEventListener("touchend", () => dibujando = false);

  btnAbrirFirma.addEventListener("click", () => {

    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    if (!fotosInput.files || fotosInput.files.length < 2) {
      showToast("Debes subir al menos 2 fotos.");
      return;
    }

    modalFirma.show();
  });

  btnGuardarFirma.addEventListener("click", () => {

    if (!hayFirma) {
      showToast("La firma es obligatoria.");
      return;
    }

    document.getElementById("firma_input").value = canvas.toDataURL("image/png");
    form.submit();
  });

  window.limpiarFirma = function () {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    hayFirma = false;
  };

  function showToast(msg) {
    document.getElementById("toastMsg").innerText = msg;
    new bootstrap.Toast(document.getElementById("toastError")).show();
  }

});
</script>

{% endblock %}
