{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="m-0">Visitas</h3>
  <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">Dashboard</a>
</div>

<!-- TOASTS -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
      <div class="toast align-items-center text-bg-{{ 'danger' if cat=='danger' else ('success' if cat=='success' else 'secondary') }} border-0 mb-2"
           role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            {{ msg }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="card p-3 mb-4">
  <h5 class="mb-3">Registrar visita</h5>

  <!-- OJO: el submit real ocurre SOLO después de firmar -->
  <form id="formVisita" method="POST" action="{{ url_for('nueva_visita') }}" enctype="multipart/form-data">

    <div class="row g-2">
      <div class="col-12 col-md-4">
        <label class="form-label">Cliente *</label>
        <input type="text" name="cliente" class="form-control" required>
      </div>

      <div class="col-12 col-md-8">
        <label class="form-label">Comentarios *</label>
        <input type="text" name="comentarios" class="form-control" required>
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label">Próxima visita</label>
        <input type="date" name="proxima_visita" class="form-control">
      </div>

      <div class="col-12 col-md-8">
        <label class="form-label">Fotos (mínimo 2) *</label>
        <input type="file" name="fotos" id="fotos" class="form-control" accept="image/*" multiple required>
        <div class="form-text">Puedes seleccionar varias fotos a la vez.</div>
      </div>
    </div>

    <!-- Firma escondida (se llena al confirmar) -->
    <input type="hidden" name="firma_data" id="firma_data">

    <div class="mt-3 d-flex gap-2">
      <!-- IMPORTANTE: type="button" para que NO envíe sin firma -->
      <button type="button" class="btn btn-primary" id="btnAbrirFirma">
        Registrar visita
      </button>
    </div>
  </form>
</div>

<hr>

<h5 class="mb-3">Historial</h5>

<div class="table-responsive">
  <table class="table table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Fecha</th>
        <th>Usuario</th>
        <th>Cliente</th>
        <th>Comentarios</th>
        <th>Fotos</th>
        <th>Firma</th>
      </tr>
    </thead>
    <tbody>
      {% for a in actividades %}
      <tr>
        <td>{{ a.fecha }}</td>
        <td>{{ a.usuario }}</td>
        <td>{{ a.cliente }}</td>
        <td>{{ a.comentarios }}</td>

        <td>
          {% set fotos = fotos_map.get(a.id, []) %}
          {% if fotos and fotos|length > 0 %}
            <div class="d-flex flex-wrap gap-2">
              {% for f in fotos %}
                <a href="/static/uploads/{{ f.archivo }}" target="_blank">
                  <img src="/static/uploads/{{ f.archivo }}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;">
                </a>
              {% endfor %}
            </div>
          {% else %}
            <span class="text-muted">Sin fotos</span>
          {% endif %}
        </td>

        <td>
          {% if a.firma_archivo %}
            <a href="/static/uploads/{{ a.firma_archivo }}" target="_blank">
              <img src="/static/uploads/{{ a.firma_archivo }}" style="width:100px;height:50px;object-fit:contain;border:1px solid #ddd;border-radius:6px;">
            </a>
          {% else %}
            <span class="text-muted">Sin firma</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- MODAL FIRMA -->
<div class="modal fade" id="modalFirma" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Firma de conformidad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p class="mb-2">Firma con el dedo (obligatoria)</p>

        <canvas id="canvasFirma" width="500" height="220"
                style="width:100%; height:auto; border:1px solid #ccc; border-radius:10px;"></canvas>

        <div class="d-flex gap-2 mt-3">
          <button type="button" class="btn btn-outline-secondary btn-sm" id="btnLimpiarFirma">Limpiar</button>
          <div class="ms-auto"></div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="btnConfirmarFirma">
          Confirmar y guardar
        </button>
      </div>

    </div>
  </div>
</div>

<script>
  // ---------- TOAST helper ----------
  function showToast(message, type="danger") {
    const container = document.querySelector(".toast-container");
    const div = document.createElement("div");
    div.className = `toast align-items-center text-bg-${type} border-0 mb-2`;
    div.setAttribute("role","alert");
    div.setAttribute("aria-live","assertive");
    div.setAttribute("aria-atomic","true");
    div.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    container.appendChild(div);
    new bootstrap.Toast(div, { delay: 3500 }).show();
  }

  // Mostrar toasts que vienen del servidor
  document.querySelectorAll(".toast").forEach(t => new bootstrap.Toast(t, { delay: 3500 }).show());

  // ---------- VALIDACIÓN + MODAL ----------
  const form = document.getElementById("formVisita");
  const fotosInput = document.getElementById("fotos");
  const btnAbrirFirma = document.getElementById("btnAbrirFirma");

  const modalEl = document.getElementById("modalFirma");
  const modalFirma = new bootstrap.Modal(modalEl);

  btnAbrirFirma.addEventListener("click", () => {
    // 1) Validación HTML5 (required) aunque sea button
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    // 2) Validar mínimo 2 fotos (pop)
    const files = fotosInput.files || [];
    if (files.length < 2) {
      showToast("Debes subir mínimo 2 fotos.", "danger");
      return;
    }

    // 3) Abrir modal para firmar (solo aquí)
    modalFirma.show();
  });

  // ---------- FIRMA ----------
  const canvas = document.getElementById("canvasFirma");
  const ctx = canvas.getContext("2d");

  let drawing = false;

  function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    if (evt.touches && evt.touches[0]) {
      return {
        x: evt.touches[0].clientX - rect.left,
        y: evt.touches[0].clientY - rect.top
      };
    }
    return { x: evt.offsetX, y: evt.offsetY };
  }

  function startDraw(e) {
    drawing = true;
    ctx.beginPath();
    const p = getPos(e);
    ctx.moveTo(p.x, p.y);
  }

  function moveDraw(e) {
    if (!drawing) return;
    const p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  }

  function endDraw() {
    drawing = false;
  }

  // Mouse
  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", moveDraw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);

  // Touch
  canvas.addEventListener("touchstart", (e) => { e.preventDefault(); startDraw(e); }, {passive:false});
  canvas.addEventListener("touchmove", (e) => { e.preventDefault(); moveDraw(e); }, {passive:false});
  canvas.addEventListener("touchend", endDraw);

  document.getElementById("btnLimpiarFirma").addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  function firmaVacia() {
    const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    for (let i = 3; i < data.length; i += 4) {
      if (data[i] !== 0) return false;
    }
    return true;
  }

  document.getElementById("btnConfirmarFirma").addEventListener("click", () => {
    if (firmaVacia()) {
      showToast("La firma es obligatoria.", "danger");
      return;
    }

    // Guardar firma en hidden y enviar ahora sí
    document.getElementById("firma_data").value = canvas.toDataURL("image/png");
    modalFirma.hide();
    form.submit();
  });
</script>

{% endblock %}
