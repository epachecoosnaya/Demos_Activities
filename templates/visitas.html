{% extends "base.html" %}
{% block content %}

<h3 class="mb-3">Registrar visita</h3>

<form id="formVisita" method="POST" enctype="multipart/form-data" class="card p-3 mb-4">

  <div class="mb-2">
    <label>Cliente *</label>
    <input type="text" name="cliente" class="form-control" required>
  </div>

  <div class="mb-2">
    <label>Comentarios *</label>
    <textarea name="comentarios" class="form-control" required></textarea>
  </div>

  <div class="mb-2">
    <label>Próxima visita</label>
    <input type="date" name="proxima_visita" class="form-control">
  </div>

  <div class="mb-3">
    <label>Fotos (mínimo 2) *</label>
    <input type="file" name="fotos" id="fotos" multiple accept="image/*" class="form-control">
  </div>

  <!-- FIRMA SE MANDA OCULTA -->
  <input type="hidden" name="firma" id="firma_input">

  <button type="button" class="btn btn-primary" onclick="validarAntesFirma()">
    Registrar visita
  </button>

</form>

<hr>

<h4>Visitas registradas</h4>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Usuario</th>
      <th>Cliente</th>
      <th>Comentarios</th>
    </tr>
  </thead>
  <tbody>
    {% for a in actividades %}
    <tr>
      <td>{{ a.fecha }}</td>
      <td>{{ a.usuario }}</td>
      <td>{{ a.cliente }}</td>
      <td>{{ a.comentarios }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ================= MODAL FIRMA ================= -->
<div class="modal fade" id="modalFirma" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Firma de conformidad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">
        <p class="mb-2">Firma con el dedo</p>
        <canvas id="firma" width="320" height="160"
                style="border:1px solid #ccc; width:100%;"></canvas>

        <button class="btn btn-sm btn-secondary mt-2" onclick="limpiarFirma()">
          Limpiar firma
        </button>
      </div>

      <div class="modal-footer">
        <button class="btn btn-success" onclick="confirmarFirma()">
          Confirmar y guardar
        </button>
      </div>

    </div>
  </div>
</div>

<!-- ================= JS ================= -->
<script>
const modal = new bootstrap.Modal(document.getElementById("modalFirma"));
const canvas = document.getElementById("firma");
const ctx = canvas.getContext("2d");
let dibujando = false;

// ---------- VALIDACIONES PREVIAS ----------
function validarAntesFirma() {
  const fotos = document.getElementById("fotos").files;

  if (!fotos || fotos.length < 2) {
    alert("Debes subir mínimo 2 fotos.");
    return;
  }

  modal.show();
}

// ---------- FIRMA ----------
function pos(e) {
  const r = canvas.getBoundingClientRect();
  if (e.touches) {
    return {
      x: e.touches[0].clientX - r.left,
      y: e.touches[0].clientY - r.top
    };
  }
  return { x: e.offsetX, y: e.offsetY };
}

canvas.addEventListener("mousedown", e => {
  dibujando = true;
  ctx.beginPath();
  const p = pos(e);
  ctx.moveTo(p.x, p.y);
});
canvas.addEventListener("mousemove", e => {
  if (!dibujando) return;
  const p = pos(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
});
canvas.addEventListener("mouseup", () => dibujando = false);
canvas.addEventListener("mouseleave", () => dibujando = false);

canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  dibujando = true;
  ctx.beginPath();
  const p = pos(e);
  ctx.moveTo(p.x, p.y);
}, {passive:false});

canvas.addEventListener("touchmove", e => {
  e.preventDefault();
  if (!dibujando) return;
  const p = pos(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
}, {passive:false});

canvas.addEventListener("touchend", () => dibujando = false);

function limpiarFirma() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function firmaVacia() {
  const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
  for (let i = 3; i < pixels.length; i += 4) {
    if (pixels[i] !== 0) return false;
  }
  return true;
}

function confirmarFirma() {
  if (firmaVacia()) {
    alert("La firma es obligatoria.");
    return;
  }

  document.getElementById("firma_input").value =
    canvas.toDataURL("image/png");

  modal.hide();
  document.getElementById("formVisita").submit();
}
</script>

{% endblock %}
